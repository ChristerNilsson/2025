// Generated by CoffeeScript 2.7.0
var echo, range,
  indexOf = [].indexOf;

import {
  Edmonds
} from './blossom.js';

range = _.range;

echo = console.log;

export var FairPair = class FairPair {
  constructor(players, settings) {
    var edges, edmonds, i, j, k, l, len, len1, magic, p, r, ref, ref1;
    this.players = players;
    this.settings = settings;
    this.N = this.players.length;
    if (this.settings.sort === 1) {
      this.players.sort(function(a, b) {
        return a.elo - b.elo;
      });
    }
    this.matrix = (function() {
      var k, len, ref, results;
      ref = range(this.N);
      results = [];
      for (k = 0, len = ref.length; k < len; k++) {
        j = ref[k];
        results.push((function() {
          var l, len1, ref1, results1;
          ref1 = range(this.N);
          results1 = [];
          for (l = 0, len1 = ref1.length; l < len1; l++) {
            i = ref1[l];
            results1.push("•");
          }
          return results1;
        }).call(this));
      }
      return results;
    }).call(this);
    this.rounds = [];
    ref = range(this.settings.ROUNDS);
    for (k = 0, len = ref.length; k < len; k++) {
      r = ref[k];
      echo('lottning', r);
      edges = this.makeEdges();
      edmonds = new Edmonds(edges);
      magic = edmonds.maxWeightMatching(edges);
      this.rounds.unshift(this.updatePlayers(magic, r));
    }
    ref1 = this.players;
    for (l = 0, len1 = ref1.length; l < len1; l++) {
      p = ref1[l];
      delete p.opp;
      delete p.col;
    }
  }

  makeEdges() {
    var a, b, diff, edges, i, j, k, l, len, len1, ref, ref1;
    edges = [];
    ref = range(this.N);
    for (k = 0, len = ref.length; k < len; k++) {
      i = ref[k];
      a = this.players[i];
      ref1 = range(this.N);
      for (l = 0, len1 = ref1.length; l < len1; l++) {
        j = ref1[l];
        if (i === j) {
          this.matrix[i][j] = ' ';
        }
        b = this.players[j];
        diff = Math.abs(a.elo - b.elo);
        if (this.ok(a, b)) {
          edges.push([i, j, 10000 - diff ** 1.01]);
        }
      }
    }
    return edges;
  }

  ok(a, b) {
    var ref;
    if (a.id === b.id) {
      return false;
    }
    if (ref = a.id, indexOf.call(b.opp, ref) >= 0) {
      return false;
    }
    if (this.settings.GAMES === 2 || this.settings.BALANCE === 0) {
      return true;
    }
    return Math.abs(a.balance() + b.balance()) < this.settings.BALANCE;
  }

  save(a, b, ca, cb, ia, ib) {
    a.col += ca;
    b.col += cb;
    return this.tables.push([ia, ib]);
  }

  updatePlayers(magic, r) {
    var a, b, diff, flip, i, id, j, k, len;
    this.tables = [];
    flip = false; // om två spelare har diff==0, ska varannan bli vit, varannan svart
    for (k = 0, len = magic.length; k < len; k++) {
      id = magic[k];
      i = id;
      j = magic[id];
      if (i === this.matrix.length || j === this.matrix[0].length) {
        continue;
      }
      this.matrix[i][j] = `${'123456789abcdefghijklmnopqrstuvwxyzåäö'[r]}`;
      if (i > j) {
        continue;
      }
      diff = Math.abs(this.players[i].elo - this.players[j].elo);
      a = this.players[i];
      b = this.players[j];
      a.opp.push(j);
      b.opp.push(i);
      diff = a.balance() - b.balance();
      if (diff > 0) {
        this.save(a, b, 'b', 'w', j, i);
      } else if (diff < 0) {
        this.save(a, b, 'w', 'b', i, j);
      } else {
        if (flip) {
          this.save(a, b, 'b', 'w', j, i);
        } else {
          this.save(a, b, 'w', 'b', i, j);
        }
        flip = !flip;
      }
    }
    return this.tables;
  }

};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFpcnBhaXIuanMiLCJzb3VyY2VSb290IjoiXFwiLCJzb3VyY2VzIjpbImZhaXJwYWlyLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsSUFBQSxJQUFBLEVBQUEsS0FBQTtFQUFBOztBQUFBLE9BQUE7RUFBUyxPQUFUO0NBQUEsTUFBQTs7QUFFQSxLQUFBLEdBQVEsQ0FBQyxDQUFDOztBQUNWLElBQUEsR0FBTyxPQUFPLENBQUM7O0FBRWYsT0FBQSxJQUFhLFdBQU4sTUFBQSxTQUFBO0VBQ04sV0FBYyxRQUFBLFVBQUEsQ0FBQTtBQUNmLFFBQUEsS0FBQSxFQUFBLE9BQUEsRUFBQSxDQUFBLEVBQUEsQ0FBQSxFQUFBLENBQUEsRUFBQSxDQUFBLEVBQUEsR0FBQSxFQUFBLElBQUEsRUFBQSxLQUFBLEVBQUEsQ0FBQSxFQUFBLENBQUEsRUFBQSxHQUFBLEVBQUE7SUFEZ0IsSUFBQyxDQUFBO0lBQVMsSUFBQyxDQUFBO0lBQ3pCLElBQUMsQ0FBQSxDQUFELEdBQUssSUFBQyxDQUFBLE9BQU8sQ0FBQztJQUNkLElBQUcsSUFBQyxDQUFBLFFBQVEsQ0FBQyxJQUFWLEtBQWdCLENBQW5CO01BQTBCLElBQUMsQ0FBQSxPQUFPLENBQUMsSUFBVCxDQUFjLFFBQUEsQ0FBQyxDQUFELEVBQUcsQ0FBSCxDQUFBO2VBQVMsQ0FBQyxDQUFDLEdBQUYsR0FBUSxDQUFDLENBQUM7TUFBbkIsQ0FBZCxFQUExQjs7SUFDQSxJQUFDLENBQUEsTUFBRDs7QUFBVztBQUFBO01BQUEsS0FBQSxxQ0FBQTs7OztBQUFDO0FBQUE7VUFBQSxLQUFBLHdDQUFBOzswQkFBQTtVQUFBLENBQUE7OztNQUFELENBQUE7OztJQUNYLElBQUMsQ0FBQSxNQUFELEdBQVU7QUFFVjtJQUFBLEtBQUEscUNBQUE7O01BQ0MsSUFBQSxDQUFLLFVBQUwsRUFBZ0IsQ0FBaEI7TUFDQSxLQUFBLEdBQVEsSUFBQyxDQUFBLFNBQUQsQ0FBQTtNQUNSLE9BQUEsR0FBVSxJQUFJLE9BQUosQ0FBWSxL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UDs7SUFkTjtXQXNCQSxJQUFDLENBQUE7RUF6QmM7O0FBeENWIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRtb25kcyB9IGZyb20gJy4vYmxvc3NvbS5qcycgIFxyXG5cclxucmFuZ2UgPSBfLnJhbmdlXHJcbmVjaG8gPSBjb25zb2xlLmxvZ1xyXG5cclxuZXhwb3J0IGNsYXNzIEZhaXJQYWlyIFxyXG5cdGNvbnN0cnVjdG9yIDogKEBwbGF5ZXJzLCBAc2V0dGluZ3MpIC0+XHJcblx0XHRATiA9IEBwbGF5ZXJzLmxlbmd0aFxyXG5cdFx0aWYgQHNldHRpbmdzLnNvcnQ9PTEgdGhlbiBAcGxheWVycy5zb3J0IChhLGIpIC0+IGEuZWxvIC0gYi5lbG9cclxuXHRcdEBtYXRyaXggPSAoKFwi4oCiXCIgZm9yIGkgaW4gcmFuZ2UgQE4pIGZvciBqIGluIHJhbmdlIEBOKVxyXG5cdFx0QHJvdW5kcyA9IFtdXHJcblxyXG5cdFx0Zm9yIHIgaW4gcmFuZ2UgQHNldHRpbmdzLlJPVU5EU1xyXG5cdFx0XHRlY2hvICdsb3R0bmluZycsclxyXG5cdFx0XHRlZGdlcyA9IEBtYWtlRWRnZXMoKVxyXG5cdFx0XHRlZG1vbmRzID0gbmV3IEVkbW9uZHMgZWRnZXNcclxuXHRcdFx0bWFnaWMgPSBlZG1vbmRzLm1heFdlaWdodE1hdGNoaW5nIGVkZ2VzXHJcblx0XHRcdEByb3VuZHMudW5zaGlmdCBAdXBkYXRlUGxheWVycyBtYWdpYyxyXHJcblxyXG5cdFx0Zm9yIHAgaW4gQHBsYXllcnNcclxuXHRcdFx0ZGVsZXRlIHAub3BwXHJcblx0XHRcdGRlbGV0ZSBwLmNvbFxyXG5cclxuXHRtYWtlRWRnZXMgOiAtPlxyXG5cdFx0ZWRnZXMgPSBbXSBcclxuXHRcdGZvciBpIGluIHJhbmdlIEBOXHJcblx0XHRcdGEgPSBAcGxheWVyc1tpXVxyXG5cdFx0XHRmb3IgaiBpbiByYW5nZSBATlxyXG5cdFx0XHRcdGlmIGk9PWogdGhlbiBAbWF0cml4W2ldW2pdID0gJyAnXHJcblx0XHRcdFx0YiA9IEBwbGF5ZXJzW2pdXHJcblx0XHRcdFx0ZGlmZiA9IE1hdGguYWJzIGEuZWxvIC0gYi5lbG9cclxuXHRcdFx0XHRpZiBAb2sgYSxiIHRoZW4gZWRnZXMucHVzaCBbaSwgaiwgMTAwMDAgLSBkaWZmICoqIDEuMDFdXHJcblx0XHRlZGdlc1xyXG5cclxuXHRvayA6IChhLGIpIC0+IFxyXG5cdFx0aWYgYS5pZCA9PSBiLmlkIHRoZW4gcmV0dXJuIGZhbHNlXHJcblx0XHRpZiBhLmlkIGluIGIub3BwIHRoZW4gcmV0dXJuIGZhbHNlXHJcblx0XHRpZiBAc2V0dGluZ3MuR0FNRVMgPT0gMiBvciBAc2V0dGluZ3MuQkFMQU5DRSA9PSAwIHRoZW4gcmV0dXJuIHRydWVcclxuXHRcdE1hdGguYWJzKGEuYmFsYW5jZSgpICsgYi5iYWxhbmNlKCkpIDwgQHNldHRpbmdzLkJBTEFOQ0VcclxuXHJcblx0c2F2ZSA6IChhLCBiLCBjYSwgY2IsIGlhLCBpYikgLT5cclxuXHRcdGEuY29sICs9IGNhXHJcblx0XHRiLmNvbCArPSBjYlxyXG5cdFx0QHRhYmxlcy5wdXNoIFtpYSwgaWJdXHJcblxyXG5cdHVwZGF0ZVBsYXllcnMgOiAobWFnaWMscikgLT4gXHJcblx0XHRAdGFibGVzID0gW11cclxuXHRcdGZsaXAgPSBmYWxzZSAjIG9tIHR2w6Ugc3BlbGFyZSBoYXIgZGlmZj09MCwgc2thIHZhcmFubmFuIGJsaSB2aXQsIHZhcmFubmFuIHN2YXJ0XHJcblx0XHRmb3IgaWQgaW4gbWFnaWNcclxuXHRcdFx0aSA9IGlkXHJcblx0XHRcdGogPSBtYWdpY1tpZF1cclxuXHRcdFx0aWYgaSA9PSBAbWF0cml4Lmxlbmd0aCBvciBqID09IEBtYXRyaXhbMF0ubGVuZ3RoIHRoZW4gY29udGludWVcclxuXHRcdFx0QG1hdHJpeFtpXVtqXSA9IFwiI3snMTIzNDU2Nzg5YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXrDpcOkw7YnW3JdfVwiXHJcblx0XHRcdGlmIGkgPiBqIHRoZW4gY29udGludWVcclxuXHRcdFx0ZGlmZiA9IE1hdGguYWJzIEBwbGF5ZXJzW2ldLmVsbyAtIEBwbGF5ZXJzW2pdLmVsb1xyXG5cdFx0XHRhID0gQHBsYXllcnNbaV1cclxuXHRcdFx0YiA9IEBwbGF5ZXJzW2pdXHJcblx0XHRcdGEub3BwLnB1c2ggalxyXG5cdFx0XHRiLm9wcC5wdXNoIGlcclxuXHRcdFx0ZGlmZiA9IGEuYmFsYW5jZSgpIC0gYi5iYWxhbmNlKClcclxuXHRcdFx0aWYgZGlmZiA+IDBcclxuXHRcdFx0XHRAc2F2ZSBhLGIsJ2InLCd3JyxqLGlcclxuXHRcdFx0ZWxzZSBpZiBkaWZmIDwgMFxyXG5cdFx0XHRcdEBzYXZlIGEsYiwndycsJ2InLGksalxyXG5cdFx0XHRlbHNlIFxyXG5cdFx0XHRcdGlmIGZsaXBcclxuXHRcdFx0XHRcdEBzYXZlIGEsYiwnYicsJ3cnLGosaSBcclxuXHRcdFx0XHRlbHNlIFxyXG5cdFx0XHRcdFx0QHNhdmUgYSxiLCd3JywnYicsaSxqXHJcblx0XHRcdFx0ZmxpcCA9IG5vdCBmbGlwXHJcblx0XHRAdGFibGVzXHJcbiJdfQ==
//# sourceURL=c:\github\2025\035-FairPair\fairpair.coffee