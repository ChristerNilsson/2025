// Generated by CoffeeScript 2.7.0
var accum, echo, range,
  indexOf = [].indexOf;

import {
  Edmonds
} from './blossom.js';

range = _.range;

echo = console.log;

accum = 0;

export var FairPair = class FairPair {
  constructor(players, settings) {
    var edges, edmonds, i, j, k, l, len, len1, magic, p, r, ref, ref1;
    this.players = players;
    this.settings = settings;
    this.N = this.players.length;
    if (this.settings.sort === 1) {
      this.players.sort(function(a, b) {
        return a.elo - b.elo;
      });
    }
    this.matrix = (function() {
      var k, len, ref, results;
      ref = range(this.N);
      results = [];
      for (k = 0, len = ref.length; k < len; k++) {
        j = ref[k];
        results.push((function() {
          var l, len1, ref1, results1;
          ref1 = range(this.N);
          results1 = [];
          for (l = 0, len1 = ref1.length; l < len1; l++) {
            i = ref1[l];
            results1.push("•");
          }
          return results1;
        }).call(this));
      }
      return results;
    }).call(this);
    this.rounds = [];
    ref = range(this.settings.ROUNDS);
    for (k = 0, len = ref.length; k < len; k++) {
      r = ref[k];
      echo('lottning', r);
      edges = this.makeEdges();
      edmonds = new Edmonds(edges);
      magic = edmonds.maxWeightMatching(edges);
      this.rounds.unshift(this.updatePlayers(magic, r));
    }
    ref1 = this.players;
    for (l = 0, len1 = ref1.length; l < len1; l++) {
      p = ref1[l];
      delete p.opp;
      delete p.col;
    }
  }

  makeEdges() {
    var a, b, diff, edges, i, j, k, l, len, len1, ref, ref1;
    edges = [];
    ref = range(this.N);
    for (k = 0, len = ref.length; k < len; k++) {
      i = ref[k];
      a = this.players[i];
      ref1 = range(this.N);
      for (l = 0, len1 = ref1.length; l < len1; l++) {
        j = ref1[l];
        if (i === j) {
          this.matrix[i][j] = ' ';
        }
        b = this.players[j];
        diff = Math.abs(a.elo - b.elo);
        if (this.ok(a, b)) {
          edges.push([i, j, 10000 - diff ** 1.01]);
        }
      }
    }
    return edges;
  }

  ok(a, b) {
    var ref;
    if (a.id === b.id) {
      return false;
    }
    if (ref = a.id, indexOf.call(b.opp, ref) >= 0) {
      return false;
    }
    if (this.settings.GAMES === 2) {
      return true;
    }
    return Math.abs(a.balance() + b.balance()) < 1; //@settings.BALANCE
  }

  save(a, b, ca, cb, ia, ib) {
    a.col += ca;
    b.col += cb;
    return this.tables.push([ia, ib]);
  }

  updatePlayers(magic, r) {
    var a, b, diff, flip, i, id, j, k, len;
    this.tables = [];
    flip = false; // om två spelare har diff==0, ska varannan bli vit, varannan svart
    for (k = 0, len = magic.length; k < len; k++) {
      id = magic[k];
      i = id;
      j = magic[id];
      if (i === this.matrix.length || j === this.matrix[0].length) {
        continue;
      }
      this.matrix[i][j] = `${'123456789abcdefghijklmnopqrstuvwxyzåäö'[r]}`;
      if (i > j) {
        continue;
      }
      diff = Math.abs(this.players[i].elo - this.players[j].elo);
      accum += diff;
      a = this.players[i];
      b = this.players[j];
      a.opp.push(j);
      b.opp.push(i);
      diff = a.balance() - b.balance();
      if (diff > 0) {
        this.save(a, b, 'b', 'w', j, i);
      } else if (diff < 0) {
        this.save(a, b, 'w', 'b', i, j);
      } else {
        if (flip) {
          this.save(a, b, 'b', 'w', j, i);
        } else {
          this.save(a, b, 'w', 'b', i, j);
        }
        flip = !flip;
      }
    }
    echo('accum', accum);
    return this.tables;
  }

};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFpcnBhaXIuanMiLCJzb3VyY2VSb290IjoiXFwiLCJzb3VyY2VzIjpbImZhaXJwYWlyLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsSUFBQSxLQUFBLEVBQUEsSUFBQSxFQUFBLEtBQUE7RUFBQTs7QUFBQSxPQUFBO0VBQVMsT0FBVDtDQUFBLE1BQUE7O0FBRUEsS0FBQSxHQUFRLENBQUMsQ0FBQzs7QUFDVixJQUFBLEdBQU8sT0FBTyxDQUFDOztBQUNmLEtBQUEsR0FBUTs7QUFFUixPQUFBLElBQWEsV0FBTixNQUFBLFNBQUE7RUFDTixXQUFjLFFBQUEsVUFBQSxDQUFBO0FBQ2YsUUFBQSxLQUFBLEVBQUEsT0FBQSxFQUFBLENBQUEsRUFBQSxDQUFBLEVBQUEsQ0FBQSxFQUFBLENBQUEsRUFBQSxHQUFBLEVBQUEsSUFBQSxFQUFBLEtBQUEsRUFBQSxDQUFBLEVBQUEsQ0FBQSxFQUFBLEdBQUEsRUFBQTtJQURnQixJQUFDLENBQUE7SUFBUyxJQUFDLENBQUE7SUFDekIsSUFBQyxDQUFBLENBQUQsR0FBSyxJQUFDLENBQUEsT0FBTyxDQUFDO0lBQ2QsSUFBRyxJQUFDLENBQUEsUUFBUSxDQUFDLElBQVYsS0FBZ0IsQ0FBbkI7TUFBMEIsSUFBQyxDQUFBLE9BQU8sQ0FBQyxJQUFULENBQWMsUUFBQSxDQUFDLENBQUQsRUFBRyxDQUFILENBQUE7ZUFBUyxDQUFDLENBQUMsR0FBRixHQUFRLENBQUMsQ0FBQztNQUFuQixDQUFkLEVBQTFCOztJQUNBLElBQUMsQ0FBQSxNQUFEOztBQUFXO0FBQUE7TUFBQSxLQUFBLHFDQUFBOzs7O0FBQUM7QUFBQTtVQUFBLEtBQUEsd0NBQUE7OzBCQUFBO1VBQUEsQ0FBQTs7O01BQUQsQ0FBQTs7O0lBQ1gsSUFBQyxDQUFBLE1BQUQsR0FBVTtBQUVWO0lBQUEsS0FBQSxxQ0FBQTs7TUFDQyxJQUFBLENBQUssVUFBTCxFQUFnQixDQUFoQjtNQUNBLEtBQUEsR0FBUSxJQUFDLENBQUEsU0FBRCxDQUFBO01BQ1IsT0FBQSxHQUFVLElBQUksT0FBSixDQUFZLEtBQVo7TUFDVixLQUFBLEdBQVEsT0FBTyxDQUFDLGlCQUFSLENBQTBCLEtBQTFCO01BQ1IsSUFBQyxDQUFBLE1BQU0sQ0FBQyxPQUFSLENBQWdCLElBQUMsQ0FBQSxhQUFELENBQWUsS0FBZixFQUFxQixDQUFyQixDQUFoQjtJQUxEO0FBT0E7SUFBQSxLQUFBLHdDQUFBOztNQUNDLE9BQU8sQ0FBQyxDQUFDO01BQ1QsT0FBTyxDQUFDLENBQUM7SUFGVjtFQWJhOztFQWlCZCxTQUFZLENBQUEsQ0FBQTtBQUNiLFFBQUEsQ0FBQSxFQUFBLENBQUEsRUFBQSxJQUFBLEVBQUEsS0FBQSxFQUFBLENBQUEsRUFBQSxDQUFBLEVBQUEsQ0FBQSxFQUFBLENBQUEsRUFBQSxHQUFBLEVBQUEsSUFBQSxFQUFBLEdBQUEsRUFBQTtJQUFFLEtBQUEsR0FBUTtBQUNSO0lBQUEsS0FBQSxxQ0FBQTs7TUFDQyxDQUFBLEdBQUksSUFBQyxDQUFBLE9BQU8sQ0FBQyxDQUFEO0FBQ1o7TUFBQSxLQUFBLHdDQUFBOztRQUNDLElBQUcsQ0FBQSxLQUFHLENBQU47VUFBYSxJQUFDLENBQUEsTUFBTSxDQUFDLENBQUQsQ0FBRyxDQUFDLENBQUQsQ0FBVixHQUFnQixJQUE3Qjs7UUFDQSxDQUFBLEdBQUksSUFBQyxDQUFBLE9BQU8sQ0FBQyxDQUFEO1FBQ1osSUFBQSxHQUFPLElBQUksQ0FBQyxHQUFMLENBQVMsQ0FBQyxDQUFDLEdBQUYsR0FBUSxDQUFDLENBQUMsR0FBbkI7UUFDUCxJQUFHLElBQUMsQ0FBQSxFQUFELENBQUksQ0FBSixFQUFNLENBQU4sQ0FBSDtVQUFnQixLQUFLLENBQUMsSUFBTixDQUFXLENBQUMsQ0FBRCxFQUFJLENBQUosRUFBTyxLQUFBLEdBQVEsSUFBQSxJQUFRLElBQXZCLENBQVgsRUFBaEI7O01BSkQ7SUFGRDtXQU9BO0VBVFc7O0VBV1osRUFBSyxDQUFDLENBQUQsRUFBRyxDQUFILENBQUE7QUFDTixRQUFBO0lBQUUsSUFBRyxDQUFDLENBQUMsRUFBRixLQUFRLENBQUMsQ0FBQyxFQUFiO0FBQXFCLGFBQU8sTUFBNUI7O0lBQ0EsVUFBRyxDQUFDLENBQUMsaUJBQU0sQ0FBQyxDQUFDLEtBQVYsU0FBSDtBQUFzQixhQUFPLE1BQTdCOztJQUNBLElBQUcsSUFBQyxDQUFBLFFBQVEsQ0FBQyxLQUFWLEtBQW1CLENBQXRCO0FBQTZCLGFBQU8sS0FBcEM7O1dBQ0EsSUFBSSxDQUFDLEdBQUwsQ0FBUyxDQUFDLENBQUMsT0FBRixDQUFBLENBQUEsR0FBYyxDQUFDLENBQUMsT0FBRixDQUFBLENBQXZCLENBQUEsR0FBc0MsRUFKbEM7RUFBQTs7RUFNTCxJQUFPLENBQUMsQ0FBRCxFQUFJLENBQUosRUFBTyxFQUFQLEVBQVcsRUFBWCxFQUFlLEVBQWYsRUFBbUIsRUFBbkIsQ0FBQTtJQUNOLENBQUMsQ0FBQyxHQUFGLElBQVM7SUFDVCxDQUFDLENBQUMsR0FBRixJQUFTO1dBQ1QsSUFBQyxDQUFBLE1BQU0sQ0FBQyxJQUFSLENBQWEsQ0FBQyxFQUFELEVBQUssRUFBTCxDQUFiO0VBSE07O0VBS1AsYUFBZ0IsQ0FBQyxLQUFELEVBQU8sQ0FBUCxDQUFBO0FBQ2pCLFFBQUEsQ0FBQSxFQUFBLENBQUEsRUFBQSxJQUFBLEVBQUEsSUFBQSxFQUFBLENBQUEsRUFBQSxFQUFBLEVBQUEsQ0FBQSxFQUFBLENBQUEsRUFBQTtJQUFFLElBQUMsQ0FBQSxNQUFELEdBQVU7SUFDVixJQUFBLEdBQU8sTUFEVDtJQUVFLEtBQUEsdUNBQUE7O01BQ0MsQ0FBQSxHQUFJO01BQ0osQ0FBQSxHQUFJLEtBQUssQ0FBQyxFQUFEO01BQ1QsSUFBRyxDQUFBLEtBQUssSUFBQyxDQUFBLE1BQU0sQ0FBQyxNQUFiLElBQXVCLENBQUEsS0FBSyxJQUFDLENBQUEsTUFBTSxDQUFDLENBQUQsQ0FBRyxDQUFDLE1BQTFDO0FBQXNELGlCQUF0RDs7TUFDQSxJQUFDLENBQUEsTUFBTSxDQUFDLENBQUQsQ0FBRyxDQUFDLENBQUQsQ0FBVixHQUFnQixDQUFBLENBQUEsQ0FBRyx3Q0FBd0MsQ0FBQyxDQUFELENBQTNDLENBQUE7TUFDaEIsSUFBRyxDQUFBLEdBQUksQ0FBUDtBQUFjLGlCQUFkOztNQUNBLElBQUEsR0FBTyxJQUFJLENBQUMsR0FBTCxDQUFTLElBQUMsQ0FBQSxPQUFPLENBQUMsQ0FBRCxDQUFHLENBQUMsR0FBWixHQUFrQixJQUFDLENBQUEsT0FBTyxDQUFDLENBQUQsQ0FBRyxDQUFDLEdBQXZDO01BQ1AsS0FBQSxJQUFTO01BQ1QsQ0FBQSxHQUFJLElBQUMsQ0FBQSxPQUFPLENBQUMsQ0FBRDtNQUNaLENBQUEsR0FBSSxJQUFDLENBQUEsT0FBTyxDQUFDLENBQUQ7TUFDWixDQUFDLENBQUMsR0FBRyxDQUFDLElBQU4sQ0FBVyxDQUFYO01BQ0EsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFOLENBQVcsQ0FBWDtNQUNBLElBQUEsR0FBTyxDQUFDLENBQUMsT0FBRixDQUFBLENBQUEsR0FBYyxDQUFDLENBQUMsT0FBRixDQUFBO01BQ3JCLElBQUcsSUFBQSxHQUFPLENBQVY7UUFDQyxJQUFDLENBQUEsSUFBRCxDQUFNLENBQU4sRUFBUSxDQUFSLEVBQVUsR0FBVixFQUFjLEdBQWQsRUFBa0IsQ0FBbEIsRUFBb0IsQ0FBcEIsRUFERDtPQUFBLE1BRUssSUFBRyxJQUFBLEdBQU8sQ0FBVjtRQUNKLElBQUMsQ0FBQSxJQUFELENBQU0sQ0FBTixFQUFRLENBQVIsRUFBVSxHQUFWLEVBQWMsR0FBZCxFQUFrQixDQUFsQixFQUFvQixDQUFwQixFQURJO09BQUEsTUFBQTtRQUdKLElBQUcsSUFBSDtVQUNDLElBQUMsQ0FBQSxJQUFELENBQU0sQ0FBTixFQUFRLENBQVIsRUFBVSxHQUFWLEVBQWMsR0FBZCxFQUFrQixDQUFsQixFQUFvQixDQUFwQixFQUREO1NBQUEsTUFBQTtVQUdDLElBQUMsQ0FBQSxJQUFELENBQU0sQ0FBTixFQUFRLENBQVIsRUFBVSxHQUFWLEVBQWMsR0FBZCxFQUFrQixDQUFsQixFQUFvQixDQUFwQixFQUhEOztRQUlBLElBQUEsR0FBTyxDQUFJLEtBUFA7O0lBZk47SUF1QkEsSUFBQSxDQUFLLE9BQUwsRUFBYSxLQUFiO1dBQ0EsSUFBQyxDQUFBO0VBM0JjOztBQXhDViIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkbW9uZHMgfSBmcm9tICcuL2Jsb3Nzb20uanMnICBcclxuXHJcbnJhbmdlID0gXy5yYW5nZVxyXG5lY2hvID0gY29uc29sZS5sb2dcclxuYWNjdW0gPSAwXHJcblxyXG5leHBvcnQgY2xhc3MgRmFpclBhaXIgXHJcblx0Y29uc3RydWN0b3IgOiAoQHBsYXllcnMsIEBzZXR0aW5ncykgLT5cclxuXHRcdEBOID0gQHBsYXllcnMubGVuZ3RoXHJcblx0XHRpZiBAc2V0dGluZ3Muc29ydD09MSB0aGVuIEBwbGF5ZXJzLnNvcnQgKGEsYikgLT4gYS5lbG8gLSBiLmVsb1xyXG5cdFx0QG1hdHJpeCA9ICgoXCLigKJcIiBmb3IgaSBpbiByYW5nZSBATikgZm9yIGogaW4gcmFuZ2UgQE4pXHJcblx0XHRAcm91bmRzID0gW11cclxuXHJcblx0XHRmb3IgciBpbiByYW5nZSBAc2V0dGluZ3MuUk9VTkRTXHJcblx0XHRcdGVjaG8gJ2xvdHRuaW5nJyxyXHJcblx0XHRcdGVkZ2VzID0gQG1ha2VFZGdlcygpXHJcblx0XHRcdGVkbW9uZHMgPSBuZXcgRWRtb25kcyBlZGdlc1xyXG5cdFx0XHRtYWdpYyA9IGVkbW9uZHMubWF4V2VpZ2h0TWF0Y2hpbmcgZWRnZXNcclxuXHRcdFx0QHJvdW5kcy51bnNoaWZ0IEB1cGRhdGVQbGF5ZXJzIG1hZ2ljLHJcclxuXHJcblx0XHRmb3IgcCBpbiBAcGxheWVyc1xyXG5cdFx0XHRkZWxldGUgcC5vcHBcclxuXHRcdFx0ZGVsZXRlIHAuY29sXHJcblxyXG5cdG1ha2VFZGdlcyA6IC0+XHJcblx0XHRlZGdlcyA9IFtdIFxyXG5cdFx0Zm9yIGkgaW4gcmFuZ2UgQE5cclxuXHRcdFx0YSA9IEBwbGF5ZXJzW2ldXHJcblx0XHRcdGZvciBqIGluIHJhbmdlIEBOXHJcblx0XHRcdFx0aWYgaT09aiB0aGVuIEBtYXRyaXhbaV1bal0gPSAnICdcclxuXHRcdFx0XHRiID0gQHBsYXllcnNbal1cclxuXHRcdFx0XHRkaWZmID0gTWF0aC5hYnMgYS5lbG8gLSBiLmVsb1xyXG5cdFx0XHRcdGlmIEBvayBhLGIgdGhlbiBlZGdlcy5wdXNoIFtpLCBqLCAxMDAwMCAtIGRpZmYgKiogMS4wMV1cclxuXHRcdGVkZ2VzXHJcblxyXG5cdG9rIDogKGEsYikgLT4gXHJcblx0XHRpZiBhLmlkID09IGIuaWQgdGhlbiByZXR1cm4gZmFsc2VcclxuXHRcdGlmIGEuaWQgaW4gYi5vcHAgdGhlbiByZXR1cm4gZmFsc2VcclxuXHRcdGlmIEBzZXR0aW5ncy5HQU1FUyA9PSAyIHRoZW4gcmV0dXJuIHRydWVcclxuXHRcdE1hdGguYWJzKGEuYmFsYW5jZSgpICsgYi5iYWxhbmNlKCkpIDwgMSAjQHNldHRpbmdzLkJBTEFOQ0VcclxuXHJcblx0c2F2ZSA6IChhLCBiLCBjYSwgY2IsIGlhLCBpYikgLT5cclxuXHRcdGEuY29sICs9IGNhXHJcblx0XHRiLmNvbCArPSBjYlxyXG5cdFx0QHRhYmxlcy5wdXNoIFtpYSwgaWJdXHJcblxyXG5cdHVwZGF0ZVBsYXllcnMgOiAobWFnaWMscikgLT4gXHJcblx0XHRAdGFibGVzID0gW11cclxuXHRcdGZsaXAgPSBmYWxzZSAjIG9tIHR2w6Ugc3BlbGFyZSBoYXIgZGlmZj09MCwgc2thIHZhcmFubmFuIGJsaSB2aXQsIHZhcmFubmFuIHN2YXJ0XHJcblx0XHRmb3IgaWQgaW4gbWFnaWNcclxuXHRcdFx0aSA9IGlkXHJcblx0XHRcdGogPSBtYWdpY1tpZF1cclxuXHRcdFx0aWYgaSA9PSBAbWF0cml4Lmxlbmd0aCBvciBqID09IEBtYXRyaXhbMF0ubGVuZ3RoIHRoZW4gY29udGludWVcclxuXHRcdFx0QG1hdHJpeFtpXVtqXSA9IFwiI3snMTIzNDU2Nzg5YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXrDpcOkw7YnW3JdfVwiXHJcblx0XHRcdGlmIGkgPiBqIHRoZW4gY29udGludWVcclxuXHRcdFx0ZGlmZiA9IE1hdGguYWJzIEBwbGF5ZXJzW2ldLmVsbyAtIEBwbGF5ZXJzW2pdLmVsb1xyXG5cdFx0XHRhY2N1bSArPSBkaWZmXHJcblx0XHRcdGEgPSBAcGxheWVyc1tpXVxyXG5cdFx0XHRiID0gQHBsYXllcnNbal1cclxuXHRcdFx0YS5vcHAucHVzaCBqXHJcblx0XHRcdGIub3BwLnB1c2ggaVxyXG5cdFx0XHRkaWZmID0gYS5iYWxhbmNlKCkgLSBiLmJhbGFuY2UoKVxyXG5cdFx0XHRpZiBkaWZmID4gMFxyXG5cdFx0XHRcdEBzYXZlIGEsYiwnYicsJ3cnLGosaVxyXG5cdFx0XHRlbHNlIGlmIGRpZmYgPCAwXHJcblx0XHRcdFx0QHNhdmUgYSxiLCd3JywnYicsaSxqXHJcblx0XHRcdGVsc2UgXHJcblx0XHRcdFx0aWYgZmxpcFxyXG5cdFx0XHRcdFx0QHNhdmUgYSxiLCdiJywndycsaixpIFxyXG5cdFx0XHRcdGVsc2UgXHJcblx0XHRcdFx0XHRAc2F2ZSBhLGIsJ3cnLCdiJyxpLGpcclxuXHRcdFx0XHRmbGlwID0gbm90IGZsaXBcclxuXHRcdGVjaG8gJ2FjY3VtJyxhY2N1bVxyXG5cdFx0QHRhYmxlc1xyXG4iXX0=
//# sourceURL=c:\github\2025\035-FairPair\fairpair.coffee